name: Publish

concurrency:
  group: publish
  cancel-in-progress: true

on:
  workflow_dispatch:
  schedule: # Prospect: Enable
  - cron: '0 */8 * * *' # Prospect

# Prospect: guard step permissions
permissions:
  actions: read
  contents: read
# Prospect: End

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # - name: Fail if we are attempting to run on the main branch # Prospect: Disable
      # if: ${{GITHUB.REF_NAME == 'main' && github.repository == 'Prospect-Sector/prospect-sector'}}
      # run: exit 1

    # Prospect: skip publish if main unchanged since last successful run
    - name: Skip if main has not changed since last successful publish
      id: guard
      if: github.event_name != 'workflow_dispatch'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO: ${{ github.repository }}
        WF_NAME: ${{ github.workflow }}
        BRANCH: ${{ github.ref_name }}
      run: |
        set -euo pipefail

        echo "Repo: $REPO"
        echo "Workflow: $WF_NAME"
        echo "Branch: $BRANCH"

        # Current HEAD SHA of main
        current_sha="$(gh api "repos/${REPO}/commits/${BRANCH}" --jq .sha)"
        echo "Current main SHA: $current_sha"

        # Find head_sha of last successful run of this workflow on main (excluding current run)
        last_sha="$(
          gh api "repos/${REPO}/actions/runs?branch=${BRANCH}&status=success&per_page=100" --jq \
          --arg WF_NAME "$WF_NAME" --arg CUR_RUN_ID "${{ github.run_id }}" '
            .workflow_runs
            | map(select(.name == $WF_NAME))
            | map(select((.id|tostring) != $CUR_RUN_ID))
            | sort_by(.id) | reverse
            | .[0].head_sha // empty
          '
        )"

        if [ -z "${last_sha:-}" ]; then
          echo "No previous successful run found; continuing."
          exit 0
        fi

        echo "Last successful run SHA: $last_sha"

        if [ "$current_sha" = "$last_sha" ]; then
          echo "No new commits on main since last successful publish; skipping."
          echo "skip=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "Main changed since last publish; continuing."
    # Prospect: End

    - name: Install dependencies
      if: steps.guard.outputs.skip != 'true'
      run: sudo apt-get install -y python3-paramiko python3-lxml

    - uses: actions/checkout@v4.2.2
      if: steps.guard.outputs.skip != 'true'
      with:
        submodules: 'recursive'
    - name: Setup .NET Core
      if: steps.guard.outputs.skip != 'true'
      uses: actions/setup-dotnet@v4.1.0
      with:
        dotnet-version: 10.0.x

    - name: Get Engine Tag
      if: steps.guard.outputs.skip != 'true'
      run: |
        cd RobustToolbox
        git fetch --depth=1

    - name: Install dependencies
      if: steps.guard.outputs.skip != 'true'
      run: dotnet restore

    - name: Build Packaging
      if: steps.guard.outputs.skip != 'true'
      run: dotnet build Content.Packaging --configuration Release --no-restore /m

    - name: Package server
      if: steps.guard.outputs.skip != 'true'
      run: dotnet run --project Content.Packaging server --platform win-x64 --platform win-arm64 --platform linux-x64 --platform linux-arm64 --platform osx-x64 --platform osx-arm64

    - name: Package client
      if: steps.guard.outputs.skip != 'true'
      run: dotnet run --project Content.Packaging client --no-wipe-release

    - name: Publish version
      if: steps.guard.outputs.skip != 'true'
      run: Tools/publish_multi_request.py
      env:
        PUBLISH_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
        GITHUB_REPOSITORY: ${{ vars.GITHUB_REPOSITORY }}

    # - name: Publish changelog (Discord) # Prospect: Disable
      # continue-on-error: true
      # run: Tools/actions_changelogs_since_last_run.py
      # env:
        # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # DISCORD_WEBHOOK_URL: ${{ secrets.CHANGELOG_DISCORD_WEBHOOK }}

    - name: Publish changelog (RSS)
      if: steps.guard.outputs.skip != 'true'
      continue-on-error: true
      run: Tools/actions_changelog_rss.py
      env:
        CHANGELOG_RSS_KEY: ${{ secrets.CHANGELOG_RSS_KEY }}
